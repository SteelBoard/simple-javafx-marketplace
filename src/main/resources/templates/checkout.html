<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Оформление заказа</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; margin: 0; }
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .checkout-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; font-size: 20px; color: #333; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .item-info { display: flex; align-items: center; gap: 10px; }
        .item-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #555; }
        .total-row { display: flex; justify-content: space-between; margin-top: 15px; font-size: 18px; font-weight: bold; color: #333; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-confirm { background-color: #27ae60; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

        /* !!! ДОБАВЛЕНЫ СТИЛИ ДЛЯ ОШИБКИ !!! */
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container">
    <h1>Оформление заказа</h1>

    <!-- !!! БЛОК ВЫВОДА ОШИБКИ !!! -->
    <div th:if="${error}" class="alert-error">
        <span th:text="${error}">Текст ошибки</span>
    </div>

    <div th:if="${#lists.isEmpty(cartItems)}">
        <p>Корзина пуста. <a th:href="@{/}">В каталог</a></p>
    </div>

    <!--
       У select удален required, чтобы проверку делал сервер (Spring)
       и выводил красивую ошибку, а не браузерное стандартное сообщение.
       Но можно и оставить required, тогда сработают обе защиты.
    -->
    <form th:if="${!#lists.isEmpty(cartItems)}" id="checkout-form" method="post" th:action="@{/checkout}">
        <div class="checkout-grid">
            <!-- (Остальной код формы без изменений) -->

            <div class="card">
                <h2>1. Выберите товары для заказа</h2>
                <div th:each="item : ${cartItems}" class="item-row">
                    <div class="checkbox-wrapper">
                        <!-- ... контент товаров ... -->
                        <input type="checkbox" class="select-product" checked
                               th:data-id="${item.product.id}"
                               th:data-price="${item.product.price}"
                               th:data-qty="${item.quantity}">
                        <div class="item-info">
                            <img th:src="@{${item.product.mainImageUrl}}" class="item-img">
                            <div>
                                <div th:text="${item.product.name}" style="font-weight: 500;">Name</div>
                                <div style="font-size: 12px; color: #777;" th:text="${item.quantity} + ' шт. x ' + ${item.product.price} + ' ₽'"></div>
                            </div>
                        </div>
                    </div>
                    <div th:text="${item.quantity * item.product.price} + ' ₽'" style="font-weight: 600;">000 ₽</div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>2. Доставка (ПВЗ)</h2>
                    <div class="form-group">
                        <label>Фильтр по городу</label>
                        <input type="text" id="city-filter" placeholder="Начните вводить город...">
                    </div>
                    <div class="form-group">
                        <label>Выберите пункт выдачи <span style="color:red">*</span></label>

                        <!-- select оставляем как есть, или убираем required если хотим тестировать серверную ошибку -->
                        <select name="pickupPointId" id="pickup-point" size="5" style="height: 120px;">
                            <option value="" disabled selected>-- Выберите из списка --</option>
                            <option th:each="pp : ${pickupPoints}" th:value="${pp.id}" th:text="${pp.address.city + ', ' + pp.address.street + ' ' + pp.address.houseNumber}"></option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h2>Итого</h2>
                    <div class="summary-row">
                        <span>Товары (<span id="count-label">0</span>)</span>
                        <span id="subtotal-label">0.00 ₽</span>
                    </div>
                    <div class="summary-row">
                        <span>Доставка</span>
                        <span>Бесплатно</span>
                    </div>
                    <div class="total-row">
                        <span>К оплате:</span>
                        <span id="total-label">0.00 ₽</span>
                    </div>

                    <input type="hidden" name="selectedProductIds" id="selected-product-ids">
                    <button type="submit" class="btn-confirm">Подтвердить заказ</button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Скрипт оставляем как есть -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // ... ваш JS код без изменений ...
        const checkboxes = document.querySelectorAll(".select-product");
        const totalLabel = document.getElementById("total-label");
        const subtotalLabel = document.getElementById("subtotal-label");
        const countLabel = document.getElementById("count-label");
        const hiddenInput = document.getElementById("selected-product-ids");
        const cityFilter = document.getElementById("city-filter");
        const pickupSelect = document.getElementById("pickup-point");

        function recalc() {
            let sum = 0;
            let count = 0;
            let ids = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const price = parseFloat(cb.dataset.price);
                    const qty = parseInt(cb.dataset.qty);
                    sum += price * qty;
                    count += qty;
                    ids.push(cb.dataset.id);
                }
            });

            const formattedSum = sum.toFixed(2) + ' ₽';
            totalLabel.textContent = formattedSum;
            subtotalLabel.textContent = formattedSum;
            countLabel.textContent = count;
            hiddenInput.value = ids.join(",");
        }

        checkboxes.forEach(cb => cb.addEventListener("change", recalc));
        recalc();

        cityFilter.addEventListener("input", () => {
            const val = cityFilter.value.toLowerCase();
            Array.from(pickupSelect.options).forEach(opt => {
                if(opt.disabled) return;
                opt.style.display = opt.text.toLowerCase().includes(val) ? 'block' : 'none';
            });
            if(pickupSelect.selectedOptions[0] && pickupSelect.selectedOptions[0].style.display === 'none') {
                pickupSelect.value = "";
            }
        });

        document.getElementById('checkout-form').addEventListener('submit', (e) => {
            if(!hiddenInput.value) { e.preventDefault(); alert('Выберите хотя бы один товар!'); }
        });
    });
</script>

</body>
</html>