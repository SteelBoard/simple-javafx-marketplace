<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.name}">Товар</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; margin: 0; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .gallery-main { width: 100%; aspect-ratio: 1/1; object-fit: contain; border-radius: 8px; border: 1px solid #f0f0f0; margin-bottom: 10px; }
        .gallery-thumbs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; opacity: 0.7; transition: 0.2s; }
        .thumb:hover, .thumb.active { border-color: #3498db; opacity: 1; }
        h1 { margin-top: 0; font-size: 28px; color: #333; line-height: 1.2; }
        .price-tag { font-size: 32px; font-weight: bold; color: #333; margin: 15px 0; }
        .rating { color: #f5c518; font-size: 18px; margin-bottom: 20px; }
        .btn-add { display: inline-block; background-color: #3498db; color: white; padding: 15px 30px; text-decoration: none; border-radius: 6px; font-size: 18px; font-weight: 600; transition: 0.2s; }
        .btn-add:hover { background-color: #2980b9; transform: translateY(-2px); }
        .desc-block { margin-top: 30px; }
        .desc-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #3498db; display: inline-block; padding-bottom: 5px; }
        .desc-text { color: #555; line-height: 1.6; }
        .reviews-section { margin-top: 40px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .review-card { border-bottom: 1px solid #eee; padding: 20px 0; }
        .review-card:last-child { border-bottom: none; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .user-name { font-weight: bold; color: #333; }
        .review-rating { color: #f5c518; }
        .review-text { color: #555; line-height: 1.5; }
        .form-review { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .form-review textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container">
    <div class="product-grid">

        <!-- БЛОК С ФОТОГРАФИЯМИ -->
        <div>
            <!-- Большая картинка -->
            <img id="mainImage" th:src="@{${product.mainImageUrl}}" class="gallery-main" alt="Product">

            <div class="gallery-thumbs">
                <!-- 1. Выводим главную картинку первой и активной -->
                <img th:src="@{${product.mainImageUrl}}" class="thumb active" onclick="setMainImage(this)">

                <!-- 2. Выводим остальные картинки, ИСКЛЮЧАЯ главную (чтобы не было дубля) -->
                <img th:each="img : ${product.images}"
                     th:if="${img.type.name() != 'MAIN'}"
                     th:src="@{${img.filepath}}"
                     class="thumb"
                     onclick="setMainImage(this)">
            </div>
        </div>


        <div>
            <h1 th:text="${product.name}">Название товара</h1>

            <div class="rating">
                <span th:text="'★ ' + ${product.rating}">★ 4.5</span>
                <span style="color: #999; font-size: 14px; margin-left: 10px;">(Оценок: <span th:text="${#lists.size(reviews)}">10</span>)</span>
            </div>


            <div class="price-tag" th:text="${product.price} + ' ₽'">9 990 ₽</div>

            <a th:href="@{/cart/add/{sku}(sku=${product.sku})}" class="btn-add">Добавить в корзину</a>

            <div class="desc-block">
                <div class="desc-title">Описание</div>
                <div class="desc-text" th:text="${product.description}">Описание товара...</div>
            </div>
        </div>
    </div>


    <div class="reviews-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Отзывы</h2>
            <a th:href="@{/product/{sku}/reviews/all(sku=${product.sku})}" style="color:#3498db; text-decoration:none;">Все отзывы →</a>
        </div>

        <div class="form-review" sec:authorize="isAuthenticated()">
            <h4 style="margin-top:0;">Оставить отзыв</h4>
            <form th:action="@{/product/{sku}/review(sku=${product.sku})}" method="post">
                <div style="margin-bottom:10px;">
                    <label>Оценка:</label>
                    <select name="rating" style="padding:5px;">
                        <option value="5">⭐⭐⭐⭐⭐ 5</option>
                        <option value="4">⭐⭐⭐⭐ 4</option>
                        <option value="3">⭐⭐⭐ 3</option>
                        <option value="2">⭐⭐ 2</option>
                        <option value="1">⭐ 1</option>
                    </select>
                </div>
                <textarea name="comment" rows="3" placeholder="Расскажите о впечатлениях..." required></textarea>
                <button type="submit" style="background:#333; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Отправить</button>
            </form>
        </div>

        <div th:each="review, iter : ${reviews}" th:if="${iter.index < 3}" class="review-card">
            <div class="review-header">
                <span class="user-name" th:text="${review.user.username}">User</span>
                <span class="review-rating" th:text="'★ ' + ${review.rating}">★ 5</span>
            </div>
            <div class="review-text" th:text="${review.comment}">Текст...</div>
        </div>

        <div th:if="${#lists.isEmpty(reviews)}" style="color:#777; padding:20px 0;">
            Отзывов пока нет. Будьте первым!
        </div>
    </div>
</div>

<script>
    function setMainImage(imgElement) {
        document.getElementById('mainImage').src = imgElement.src;
        document.querySelectorAll('.thumb').forEach(el => el.classList.remove('active'));
        imgElement.classList.add('active');
    }
</script>

</body>
</html>