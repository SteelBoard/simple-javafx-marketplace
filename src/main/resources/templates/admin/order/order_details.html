<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Админка — Детали заказа</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; vertical-align: middle; }
        th { background: #f5f5f5; text-align: left; width: 200px; }
        .items-header th { background: #e0e0e0; text-align: center; font-weight: bold; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .btn { padding: 6px 14px; border: 1px solid #333; background: #333; color: white; cursor: pointer; text-decoration: none; display: inline-block; font-size: 13.33px; }
        .btn:hover { background: #555; }
        .links a { margin-right: 15px; text-decoration: none; color: #0066cc; }
        .links a:hover { text-decoration: underline; }
        select { padding: 4px; min-width: 300px; }
        .sub-header { margin-top: 30px; margin-bottom: 10px; color: #333; }
    </style>
</head>
<body>

<h2>Детали заказа #<span th:text="${order.id}"></span></h2>

<form th:action="@{/admin/orders/{id}/update(id=${order.id})}" method="post">
    <table>
        <tr>
            <th>ID</th>
            <td th:text="${order.id}"></td>
        </tr>

        <tr>
            <th>Покупатель</th>
            <td>
                <a th:if="${order.user != null}"
                   th:href="@{/admin/users/{id}(id=${order.user.id})}"
                   th:text="${order.user.username}" style="color: #0066cc; text-decoration: none;">
                    Username
                </a>
                <span th:if="${order.user == null}" style="color: red;">Пользователь удален</span>
            </td>
        </tr>

        <tr>
            <th>Дата создания</th>
            <td th:text="${#dates.format(order.createdAt, 'dd.MM.yyyy HH:mm')}"></td>
        </tr>

        <tr>
            <th>Статус</th>
            <td>
                <select name="status">
                    <option th:each="st : ${T(org.steelboard.marketplace.entity.OrderStatus).values()}"
                            th:value="${st}"
                            th:text="${st}"
                            th:selected="${st == order.status}"></option>
                </select>
            </td>
        </tr>

        <tr>
            <th>Пункт выдачи (ПВЗ)</th>
            <td>
                <select name="pickupPointId" required>
                    <option th:if="${order.pickupPoint == null}" value="" selected disabled>-- Выберите ПВЗ --</option>

                    <option th:each="pp : ${pickupPoints}"
                            th:value="${pp.id}"
                            th:text="|${pp.address.city}, ${pp.address.street}, д. ${pp.address.houseNumber}|"
                            th:selected="${order.pickupPoint != null and pp.id == order.pickupPoint.id}">
                    </option>
                </select>
            </td>
        </tr>

        <tr>
            <th>Сумма заказа</th>
            <td>
                <strong th:text="${#numbers.formatDecimal(order.totalAmount, 1, 2)}">0.00</strong> ₽
            </td>
        </tr>
    </table>

    <div style="margin-top: 15px;">
        <button type="submit" class="btn">Сохранить</button>
        <a th:href="@{/admin/orders}" class="btn">← Назад к списку</a>
    </div>
</form>
<h3 class="sub-header">Состав заказа</h3>

<table>
    <thead>
    <tr class="items-header">
        <th style="width: 50px;" class="text-center">#</th>
        <th>Товар</th>
        <th style="width: 150px;">Продавец</th>
        <th style="width: 100px;" class="text-right">Цена</th>
        <th style="width: 80px;" class="text-center">Кол-во</th>
        <th style="width: 120px;" class="text-right">Сумма</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${order.orderItems == null or order.orderItems.empty}">
        <td colspan="6" class="text-center" style="padding: 15px; color: #777;">Нет товаров</td>
    </tr>

    <tr th:each="item, i : ${order.orderItems}">
        <td class="text-center" th:text="${i.count}"></td>
        <td>
            <a th:if="${item.product != null}"
               th:href="@{/admin/products/{sku}(id=${item.product.sku})}"
               th:text="${item.product.name}"
               target="_blank" style="color: #0066cc; text-decoration: none;">
            </a>
            <span th:if="${item.product == null}" style="color: red;">Товар удален</span>
        </td>
        <td>
            <a th:if="${item.product != null and item.product.seller != null}"
               th:href="@{/admin/users/{id}(id=${item.product.seller.id})}"
               th:text="${item.product.seller.username}"
               style="color: #0066cc; text-decoration: none;">
            </a>
            <span th:if="${item.product != null and item.product.seller == null}">—</span>
        </td>
        <td class="text-right" th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)}"></td>
        <td class="text-center" th:text="${item.quantity}"></td>
        <td class="text-right" th:text="${#numbers.formatDecimal(item.unitPrice * item.quantity, 1, 2)}"></td>
    </tr>
    </tbody>
</table>
</body>
</html>