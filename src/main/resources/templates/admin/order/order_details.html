<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/admin_layout :: head('Заказ #' + ${order.id})}"></head>
<style>
    /* Локальные стили для панели редактирования */
    .edit-panel { background: #fdfdfd; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-left: 4px solid #333; display: none; }
    .form-row { margin-bottom: 15px; }
    .form-row label { display: block; font-weight: bold; margin-bottom: 5px; }
    .search-group { display: flex; gap: 10px; align-items: center; max-width: 500px; }
</style>
<body>

<div th:replace="~{fragments/admin_layout :: sidebar}"></div>

<div class="main-content">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="border: none; margin: 0;">Заказ #<span th:text="${order.id}"></span></h2>
            <div>

                <button onclick="toggleEdit()" class="btn btn-dark">✎ Редактировать</button>
                <a th:href="@{/admin/orders}" class="btn">К списку</a>
            </div>
        </div>

        <div th:if="${param.success}" class="badge badge-success" style="padding: 10px; display: block; margin-bottom: 15px;">✔ Данные обновлены!</div>

        <!-- Панель редактирования -->
        <div id="editPanel" class="edit-panel">
            <h3 style="margin-top: 0;">Редактирование</h3>
            <form th:action="@{/admin/orders/{id}/update(id=${order.id})}" method="post">
                <div class="form-row">
                    <label>Статус:</label>
                    <select name="status" style="width: 100%; max-width: 400px;">
                        <option th:each="st : ${statuses}" th:value="${st}" th:text="${st}" th:selected="${st == order.status}"></option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Пункт выдачи:</label>
                    <div style="margin-bottom: 5px; color: #555;">Текущий: <strong th:text="${order.pickupPoint != null ? order.pickupPoint.address : 'Не выбран'}"></strong></div>
                    <div class="search-group">
                        <input type="text" id="cityInput" placeholder="Город..." style="flex: 1;">
                        <button type="button" class="btn" onclick="searchPoints()">Найти</button>
                    </div>
                    <select name="pickupPointId" id="pickupSelect" style="margin-top: 10px; display: none; width: 100%; max-width: 500px;"></select>
                    <small id="searchMsg" style="color: #666;"></small>
                </div>
                <div style="margin-top: 15px;">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <button type="button" class="btn" onclick="toggleEdit()">Отмена</button>
                </div>
            </form>
        </div>

        <!-- Информация -->
        <table>
            <tr><th style="width: 200px;">Покупатель</th><td><a th:href="@{/admin/users/{id}(id=${order.user.id})}" th:text="${order.user.username}"></a></td></tr>
            <tr><th>Статус</th><td><span th:class="'badge ' + (${order.status.name() == 'COMPLETED'} ? 'badge-success' : (${order.status.name() == 'CANCELLED'} ? 'badge-danger' : 'badge-warning'))" th:text="${order.status}"></span></td></tr>
            <tr><th>Сумма</th><td style="font-weight: bold; font-size: 1.2em;" th:text="${order.totalAmount} + ' ₽'"></td></tr>
            <tr><th>Дата</th><td th:text="${#dates.format(order.createdAt, 'yyyy-MM-dd HH:mm')}"></td></tr>
            <tr><th>Пункт выдачи</th><td th:text="${order.pickupPoint != null ? order.pickupPoint.address : 'Не назначен'}" th:style="${order.pickupPoint == null} ? 'color: red;' : ''"></td></tr>
        </table>

        <h3 style="margin-top: 30px;">Состав заказа</h3>
        <table>
            <thead>
            <tr><th>Товар</th><th>Цена</th><th>Кол-во</th><th>Сумма</th></tr>
            </thead>
            <tbody>
            <tr th:each="item : ${order.orderItems}">
                <td><a th:href="@{/admin/products/{sku}(sku=${item.product.sku})}" th:text="${item.product.name}"></a><br><small style="color:gray;" th:text="${item.product.sku}"></small></td>
                <td th:text="${item.product.price} + ' ₽'"></td>
                <td th:text="${item.quantity}"></td>
                <td th:text="${item.product.price * item.quantity} + ' ₽'"></td>
            </tr>
            <tr style="background: #fafafa; font-weight: bold;">
                <td colspan="3" style="text-align: right;">Итого:</td>
                <td th:text="${order.totalAmount} + ' ₽'"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleEdit() {
        var panel = document.getElementById("editPanel");
        panel.style.display = (panel.style.display === "block") ? "none" : "block";
    }

    function searchPoints() {
        var city = document.getElementById("cityInput").value;
        var select = document.getElementById("pickupSelect");
        var msg = document.getElementById("searchMsg");
        if (!city) { alert("Введите город"); return; }
        msg.textContent = "Поиск...";

        fetch('/admin/orders/api/pickup-points?city=' + encodeURIComponent(city))
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="">-- Выберите (' + data.length + ') --</option>';
                data.forEach(pp => {
                    var opt = document.createElement('option');
                    opt.value = pp.id;
                    opt.innerHTML = pp.address;
                    select.appendChild(opt);
                });
                select.style.display = "block";
                msg.textContent = "";
            });
    }
</script>
</body>
</html>