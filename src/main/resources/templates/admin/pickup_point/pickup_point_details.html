<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Админка — ПВЗ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background: #f5f5f5; text-align: left; width: 200px; }

        /* Стили для кнопок */
        .btn { padding: 6px 14px; border: 1px solid #333; background: #333; color: white; cursor: pointer; text-decoration: none; display: inline-block; font-size: 13.33px; }
        .btn:hover { background: #555; }
        .btn-back { background: #fff; color: #333; margin-left: 10px; }
        .btn-back:hover { background: #eee; }

        /* Сообщения */
        .msg-box { padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .error { background-color: #fce4e4; border: 1px solid #fcc2c3; color: #cc0033; }
        .success { background-color: #e6ffe6; border: 1px solid #c3e6cb; color: #155724; }

        .links { margin-top: 30px; }
        .links a { margin-right: 15px; text-decoration: none; color: #0066cc; }
        .links a:hover { text-decoration: underline; }

        input[type="text"] { padding: 5px; width: 300px; border: 1px solid #ccc; font-size: 14px;}

        .readonly-text { color: #333; }
    </style>
</head>
<body>

<h2>Пункт выдачи (ПВЗ)</h2>

<!-- Блок сообщений -->
<div th:if="${error}" class="msg-box error" th:text="${error}"></div>
<div th:if="${param.success}" class="msg-box success">Телефон успешно обновлен!</div>

<form th:action="@{/admin/pickup-points/{id}/update(id=${pickupPoint.id})}" method="post">
    <table>
        <tr>
            <th>ID</th>
            <td th:text="${pickupPoint.id}"></td>
        </tr>

        <!-- Блок Адреса (Только чтение) -->
        <tr>
            <th>Страна</th>
            <td th:text="${pickupPoint.address.country}" class="readonly-text"></td>
        </tr>

        <tr>
            <th>Город</th>
            <td th:text="${pickupPoint.address.city}" class="readonly-text"></td>
        </tr>

        <tr>
            <th>Улица</th>
            <td th:text="${pickupPoint.address.street}" class="readonly-text"></td>
        </tr>

        <tr>
            <th>Дом</th>
            <td th:text="${pickupPoint.address.houseNumber}" class="readonly-text"></td>
        </tr>

        <tr>
            <th>Квартира / Офис</th>
            <td th:text="${pickupPoint.address.apartmentNumber != null ? pickupPoint.address.apartmentNumber : '-'}"
                class="readonly-text"></td>
        </tr>

        <tr>
            <th>Индекс</th>
            <td th:text="${pickupPoint.address.postalCode}" class="readonly-text"></td>
        </tr>

        <!-- Редактируемое поле -->
        <tr>
            <th>Телефон</th>
            <td>
                <!-- Добавили id, placeholder и maxlength -->
                <input type="text" id="phoneInput" name="phone"
                       th:value="${pickupPoint.phone}"
                       placeholder="+7 999 000-00-00"
                       maxlength="16"
                       required />
                <div style="font-size: 0.8em; color: #777; margin-top: 4px;">
                    * Формат: +7 XXX XXX-XX-XX
                </div>
            </td>
        </tr>

        <!-- Техническая информация -->
        <tr>
            <th>Дата создания</th>
            <td th:text="${#dates.format(pickupPoint.address.createdAt, 'yyyy-MM-dd HH:mm')}"
                class="readonly-text"></td>
        </tr>
    </table>

    <div style="margin-top: 15px;">
        <button type="submit" class="btn">Сохранить</button>
        <a th:href="@{/admin/pickup-points}" class="btn btn-back">← Назад к списку</a>
    </div>
</form>

<!-- Ссылки -->
<div class="links">
    <a th:href="@{/admin/orders(search=${'pvz:' + pickupPoint.id})}">
        Посмотреть все заказы на этом ПВЗ
    </a>
</div>

<!-- JavaScript Маска для телефона -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("phoneInput");

        // Функция форматирования значения
        function formatPhone(value) {
            // Удаляем всё, кроме цифр
            let digits = value.replace(/\D/g, "");

            // Если ничего не введено, возвращаем пусто
            if (!digits) return "";

            // Если первая цифра 8 (частая ошибка в РФ), меняем на 7
            if (digits[0] === "8") digits = "7" + digits.substring(1);
            // Если первая не 7, принудительно ставим 7
            if (digits[0] !== "7") digits = "7" + digits;

            // Обрезаем до 11 цифр (7 + 10 цифр номера)
            digits = digits.substring(0, 11);

            // Формируем строку по кусочкам
            let res = "+7";
            if (digits.length > 1) res += " " + digits.substring(1, 4);
            if (digits.length > 4) res += " " + digits.substring(4, 7);
            if (digits.length > 7) res += "-" + digits.substring(7, 9);
            if (digits.length > 9) res += "-" + digits.substring(9, 11);

            return res;
        }

        input.addEventListener("input", function (e) {
            // Форматируем текущее значение
            const formatted = formatPhone(e.target.value);
            e.target.value = formatted;
        });

        // При фокусе, если поле пустое, сразу ставим "+7 "
        input.addEventListener("focus", function () {
            if (this.value === "") {
                this.value = "+7 ";
            }
        });
    });
</script>

</body>
</html>