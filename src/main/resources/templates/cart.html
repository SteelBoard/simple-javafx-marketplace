<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî SteelBoard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; margin: 0; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        h1 { margin-top: 0; color: #333; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .link-back { text-decoration: none; color: #555; display: flex; align-items: center; gap: 5px; }
        .cart-card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9f9f9; text-align: left; padding: 15px; font-weight: 600; color: #555; border-bottom: 1px solid #eee; }
        td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #eee; }
        .product-col { display: flex; align-items: center; gap: 15px; }
        .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .product-name { font-weight: 500; color: #333; }
        .qty-control { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; width: fit-content; }
        .qty-btn { background: white; border: none; width: 30px; height: 30px; cursor: pointer; font-size: 16px; color: #555; }
        .qty-input { width: 40px; text-align: center; border: none; border-left: 1px solid #ddd; border-right: 1px solid #ddd; height: 30px; outline: none; }
        .price-text { font-weight: 600; color: #333; }
        .remove-btn { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 14px; }
        .cart-footer { padding: 20px; background: #fdfdfd; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; }
        .total-price { font-size: 20px; font-weight: bold; }
        .btn-checkout { background-color: #27ae60; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: 600; }
        .btn-clear { background-color: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .empty-state { text-align: center; padding: 50px; display: none; }
        .empty-icon { font-size: 50px; color: #ddd; margin-bottom: 20px; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container">
    <div class="top-bar">
        <h1>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>
        <a th:href="@{/}" class="link-back">‚Üê –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</a>
    </div>

    <div id="empty-cart" class="empty-state" th:style="${#lists.isEmpty(cartItems)} ? 'display:block;' : ''">
        <div class="empty-icon">üõí</div>
        <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
        <a th:href="@{/}" class="btn-checkout" style="background:#3498db;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
    </div>

    <div id="cart-content" class="cart-card" th:if="${!#lists.isEmpty(cartItems)}">
        <table id="cart-table">
            <thead>
            <tr>
                <th style="width: 50%;">–¢–æ–≤–∞—Ä</th>
                <th style="width: 15%;">–¶–µ–Ω–∞</th>
                <th style="width: 15%;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th style="width: 15%;">–°—É–º–º–∞</th>
                <th style="width: 5%;"></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cartItems}" th:id="'row-' + ${item.product.id}">
                <td>
                    <div class="product-col">
                        <img th:src="@{${item.product.mainImageUrl}}" class="product-img" alt="img">
                        <span th:text="${item.product.name}" class="product-name">Product</span>
                    </div>
                </td>
                <!-- –†–£–ë–õ–ò -->
                <td th:text="${item.product.price} + ' ‚ÇΩ'">0 ‚ÇΩ</td>
                <td>
                    <div class="qty-control">
                        <button class="qty-btn decrease" th:data-id="${item.product.id}">-</button>
                        <input type="text" class="qty-input" th:value="${item.quantity}" readonly>
                        <button class="qty-btn increase" th:data-id="${item.product.id}">+</button>
                    </div>
                </td>
                <!-- –†–£–ë–õ–ò -->
                <td class="price-text" th:text="${item.quantity * item.product.price} + ' ‚ÇΩ'">0 ‚ÇΩ</td>
                <td><button class="remove-btn remove" th:data-id="${item.product.id}">‚úï</button></td>
            </tr>
            </tbody>
        </table>

        <div class="cart-footer">
            <button id="clear-btn" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
            <div style="text-align: right;">
                <!-- –†–£–ë–õ–ò -->
                <div style="margin-bottom: 10px;">–ò—Ç–æ–≥–æ: <span id="total-price" class="total-price" th:text="${totalPrice} + ' ‚ÇΩ'">0.00 ‚ÇΩ</span></div>
                <a th:href="@{/checkout}" class="btn-checkout">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = document.getElementById('cart-table');
        const tbody = table ? table.querySelector('tbody') : null;
        const emptyDiv = document.getElementById('empty-cart');
        const cartContent = document.getElementById('cart-content');

        function refreshCartUI(data) {
            if (!data.cartItems || data.cartItems.length === 0) {
                if(cartContent) cartContent.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }

            const existingRows = Array.from(tbody.querySelectorAll('tr')).reduce((map, row) => {
                map[row.id] = row;
                return map;
            }, {});

            data.cartItems.forEach(item => {
                const rowId = 'row-' + item.productId;
                let row = existingRows[rowId];

                if (row) {
                    row.querySelector('.qty-input').value = item.quantity;
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω —Å–∏–º–≤–æ–ª —Ä—É–±–ª—è –≤ JS
                    row.querySelector('td:nth-child(4)').textContent = (item.quantity * item.price).toFixed(2) + ' ‚ÇΩ';
                    delete existingRows[rowId];
                }
            });

            Object.values(existingRows).forEach(row => row.remove());

            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω —Å–∏–º–≤–æ–ª —Ä—É–±–ª—è –≤ JS
            document.getElementById('total-price').textContent = (data.totalPrice ?? 0).toFixed(2) + ' ‚ÇΩ';
        }

        function apiCall(url, body) {
            return fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(r => r.json());
        }

        if (tbody) {
            tbody.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if(!row) return;
                const input = row.querySelector('.qty-input');
                const id = target.dataset.id;

                if (target.classList.contains('increase')) {
                    apiCall('/api/cart/update', {productId: id, quantity: parseInt(input.value) + 1}).then(refreshCartUI);
                } else if (target.classList.contains('decrease')) {
                    apiCall('/api/cart/update', {productId: id, quantity: Math.max(1, parseInt(input.value) - 1)}).then(refreshCartUI);
                } else if (target.classList.contains('remove')) {
                    apiCall('/api/cart/remove', {productId: id}).then(refreshCartUI);
                }
            });
        }
        const clearBtn = document.getElementById('clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) apiCall('/api/cart/clear', {}).then(refreshCartUI); });
        }
    });
</script>

</body>
</html>