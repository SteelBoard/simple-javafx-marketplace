<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Your Cart</title>
</head>
<body>
<h1>Your Shopping Cart</h1>
<div style="text-align: right;">
    <a href="/profile">My Profile</a>
</div>

<!-- Можно оставить этот блок, он не обязательный, JS создаст div, если пусто -->
<div id="empty-cart" th:if="${#lists.isEmpty(cartItems)}" style="display:none;">
    <p>Your cart is empty.</p>
    <a th:href="@{/}">Go shopping</a>
</div>

<div th:if="${!#lists.isEmpty(cartItems)}">
    <table border="1" cellpadding="10" id="cart-table">
        <thead>
        <tr>
            <th>Product</th>
            <th>Image</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${cartItems}" th:id="'row-' + ${item.product.id}">
            <td th:text="${item.product.name}"></td>
            <td><img th:src="@{${item.product.mainImageUrl}}" alt="product image" width="100"/></td>
            <td th:text="${item.product.price}"></td>
            <td>
                <button class="decrease" th:data-id="${item.product.id}">-</button>
                <input type="text" th:value="${item.quantity}" size="2" readonly/>
                <button class="increase" th:data-id="${item.product.id}">+</button>
            </td>
            <td th:text="${item.quantity * item.product.price}"></td>
            <td><button class="remove" th:data-id="${item.product.id}">Remove</button></td>
        </tr>
        </tbody>
    </table>

    <h3>Total: <span id="total-price" th:text="${totalPrice}"></span></h3>

    <a th:href="@{/}">Continue shopping</a> |
    <a th:href="@{/checkout}">Checkout</a> |
    <button id="clear" style="margin-left:10px;">Clear cart</button>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const table = document.getElementById('cart-table');
        const tbody = table ? table.querySelector('tbody') : null;

        function refreshCartUI(data) {
            if (!data.cartItems || data.cartItems.length === 0) {
                if (table) table.style.display = 'none';
                let emptyDiv = document.getElementById('empty-cart');
                if (!emptyDiv) {
                    emptyDiv = document.createElement('div');
                    emptyDiv.id = 'empty-cart';
                    emptyDiv.innerHTML = `<p>Your cart is empty.</p><a href="/">Go shopping</a>`;
                    document.body.insertBefore(emptyDiv, table || null);
                }
                emptyDiv.style.display = 'block';
                return;
            }

            if (table) table.style.display = 'table';
            const emptyDiv = document.getElementById('empty-cart');
            if (emptyDiv) emptyDiv.style.display = 'none';

            // Перерисовываем tbody
            tbody.innerHTML = '';
            data.cartItems.forEach(item => {
                const row = document.createElement('tr');
                row.id = 'row-' + item.productId;
                row.innerHTML = `
                <td>${item.productName}</td>
                <td><img src="${item.mainImageUrl}" width="100" alt="product image"></td>
                <td>${item.price.toFixed(2)}</td>
                <td>
                    <button class="decrease" data-id="${item.productId}">-</button>
                    <input type="text" value="${item.quantity}" size="2" readonly>
                    <button class="increase" data-id="${item.productId}">+</button>
                </td>
                <td>${(item.price * item.quantity).toFixed(2)}</td>
                <td><button class="remove" data-id="${item.productId}">Remove</button></td>
            `;
                tbody.appendChild(row);
            });

            // Обновляем total
            const totalPriceEl = document.getElementById('total-price');
            if (totalPriceEl) totalPriceEl.textContent = (data.totalPrice ?? 0).toFixed(2);
        }

        function updateCart(productId, quantity) {
            fetch('/api/cart/update', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ productId, quantity })
            })
                .then(r => r.json())
                .then(data => refreshCartUI(data))
                .catch(console.error);
        }

        function removeFromCart(productId) {
            fetch('/api/cart/remove', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ productId })
            })
                .then(r => r.json())
                .then(data => refreshCartUI(data))
                .catch(console.error);
        }

        function clearCart() {
            fetch('/api/cart/clear', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {'Content-Type': 'application/json'}
            })
                .then(r => r.json())
                .then(data => refreshCartUI(data))
                .catch(console.error);
        }

        // Делегирование событий на tbody
        if (tbody) {
            tbody.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('increase')) {
                    const row = target.closest('tr');
                    const input = row.querySelector('input');
                    updateCart(target.dataset.id, parseInt(input.value) + 1);
                } else if (target.classList.contains('decrease')) {
                    const row = target.closest('tr');
                    const input = row.querySelector('input');
                    updateCart(target.dataset.id, Math.max(1, parseInt(input.value) - 1));
                } else if (target.classList.contains('remove')) {
                    removeFromCart(target.dataset.id);
                }
            });
        }

        const clearBtn = document.getElementById('clear');
        if (clearBtn) {
            clearBtn.addEventListener('click', clearCart);
        }
    });
</script>

</body>
</html>
